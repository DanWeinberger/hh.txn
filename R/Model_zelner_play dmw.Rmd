## Generate simulated data
nY vector[2400]
T [2400,30]
incub[81]
obs[81]

```{r}
library(rjags)
library(HDInterval)
source('./generate_simdata_exposuretime_DMW2.R') 
#source('./generate_line_lists_zelner.R') 
#ds <- readRDS('../data/data.list.rds')
```


## d_jk(t) definition -- this first part can be computed out of JAGS

```{r}


N.samples <- 10000

## Define latent distributions
# Hyperpriors for the latent distributions
# parameterized by mode (m) and standard deviation (sd):
m1 <- runif(N.samples,2,6)
sd1 <- runif(N.samples,2,3) 
ra1 <- ( m1 + sqrt( m1^2 + 4*sd1^2 ) ) / ( 2 * sd1^2 )
sh1 <- 1 + m1 * ra1

m2 <- runif(N.samples, 2,6)
sd2 <- runif(N.samples,2,3)
ra2 <- ( m2 + sqrt( m2^2 + 4*sd2^2 ) ) / ( 2 * sd2^2 )
sh2 <- 1 + m2 * ra2

m3 <- runif(N.samples,2,6) #days
sd3 <- runif(N.samples,2,3) #SD on days
ra3 <- ( m3 + sqrt( m3^2 + 4*sd3^2 ) ) / ( 2 * sd3^2 )
sh3 <- 1 + m3 * ra3

day.infectious <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members) ))
day.exposed <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members) ))
day.infectious.end <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members+1) ))
infect.dist <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members+1) ))
expose.dist <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members+1) ))
end.inf  <- array(NA, dim=c(N.samples,N.HH,max(N.hh.members+1) ))

   n.sim <- N.samples*N.HH*max(N.hh.members)
    
   #Generate random draws for duration of infectious, 
    infect.dist <- matrix(rgamma(n.sim,sh1, ra1), ncol=N.samples) #duration infectiousness
    
    expose.dist <- 
      array(rgamma(n.sim,sh2, ra2), dim=c(N.HH,max(N.hh.members), N.samples)) 
    
    end.inf <-
      array(rgamma(n.sim,sh3,ra3),  dim=c(N.HH,max(N.hh.members), N.samples)) 

       #check
   #  day.infectious <-apply(infect.dist,2, function(x) day.matrix  )
   # day.infectious <- array(day.infectious, dim=c(dim(day.matrix),N.samples ))
   # sum(day.infectious[,,1]== day.matrix, na.rm=T) == sum(!is.na(day.infectious[,,1]))
    
   day.infectious <-apply(infect.dist,2, function(x) day.matrix - x )
   day.infectious <- array(day.infectious, dim=c(dim(day.matrix),N.samples ))
   
    day.exposed <-  
      day.infectious - expose.dist  #latent period (t_infect in the document)
    
    day.infectious.end <- 
      day.infectious + end.inf #how long infectious after onset of infectiousness
    
    #i,10000 matrix
    time.study.HH <- matrix(NA, nrow=dim(day.infectious.end)[1], N.samples)
    for( i in 1:N.samples){
      max.hh.time <- apply(day.infectious.end[,,i],1, max, na.rm=T)
      min.hh.time <- apply(day.exposed[,,i],1, min, na.rm=T)
          time.study.HH[,i] <- max.hh.time - min.hh.time
    }
    
```

Read in model
```{r}
source('../model/chain_binomial_test.R')
```

```{r}
##############################################################
#Model Fitting
##############################################################
inits1=list(".RNG.seed"=c(123), ".RNG.name"='base::Wichmann-Hill')
inits2=list(".RNG.seed"=c(456), ".RNG.name"='base::Wichmann-Hill')
inits3=list(".RNG.seed"=c(789), ".RNG.name"='base::Wichmann-Hill')



##############################################
#Model Organization
##############################################
model_spec<-textConnection(chain_binomial_jags)
model_jags<-jags.model(model_spec, 
                       #inits=list(inits1,inits2, inits3),
                       inits=list(inits1),

                                 data=list('N.HH'=N.HH,
                                 'vaxdose1'=vax,                                                       #'vaxdose2'=vaxdose2,
                                 'd.samples'=d,
                                 'N.hh.members'=N.hh.members,
                                 'day.matrix'=day.matrix,
                                 'day.infectious'=day.infectious,
                                 'day.exposed'=day.exposed,
                                 'day.infectious.end'=day.infectious.end,
                                 'y' = (1-infected_matrix),
                                 'time.study.HH'=time.study.HH
                                 #'tmax'=apply(day.matrix,1,max,na.rm=T)
                                 ),
                       n.adapt=10000, 
                       
                       n.chains=1)

```

```{r}
params<-c('alpha',
          'beta',
          'kappa',
          'delta')

##############################################
#Posterior Sampling
##############################################
posterior_samples<-coda.samples(model_jags, 
                                params, 
                                n.iter=10000)
posterior_samples.all<-do.call(rbind,posterior_samples)

post_means<-apply(posterior_samples.all, 2, median)
sample.labs<-names(post_means)
ci<-t(hdi(posterior_samples.all, credMass = 0.95))
ci<-matrix(sprintf("%.1f",round(ci,1)), ncol=2)
row.names(ci)<-sample.labs
post_means<-sprintf("%.1f",round(post_means,1))
names(post_means)<-sample.labs

alpha.index <- grep('alpha',sample.labs)
beta.index <- grep('beta',sample.labs)
kappa.index <- grep('kappa',sample.labs)
delta.index <- grep('delta',sample.labs)


ci[alpha.index,]
ci[beta.index,]
ci[kappa.index,]
ci[delta.index,]


#Test combo of beta and kappa
beta2.index <- grep('beta[2]',sample.labs, fixed=T)
kappa2.index <- grep('kappa[2]',sample.labs, fixed=T)
delta2.index <- grep('delta[2]',sample.labs, fixed=T)

beta_kappa_delta <- 
  posterior_samples.all[,beta2.index] + posterior_samples.all[,kappa2.index]
hist(beta_kappa)
```



